<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 980px;
            margin: 0 auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 28px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 12px;
            flex-wrap: wrap;
        }
        h1 { margin: 0; color: #333; }
        .actions { display: flex; gap: 10px; }
        .btn {
            border: none;
            border-radius: 8px;
            padding: 10px 14px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-muted { background: #757575; }
        .grid { display: grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 12px; }
        .field label { display: block; margin-bottom: 6px; color: #555; font-size: 13px; }
        .field input, .field select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .field input:focus, .field select:focus { outline: none; border-color: #667eea; }
        .card {
            border: 1px solid #ececec;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 22px;
            background: #fafafa;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border-bottom: 1px solid #ececec; text-align: left; font-size: 14px; }
        th { color: #555; }
        .status { font-weight: 600; }
        .ok { color: #2e7d32; }
        .bad { color: #c62828; }
        .locked { color: #d84315; font-weight: 700; }
        .warning { color: #f57c00; }
        .error {
            margin-top: 10px;
            color: #c62828;
            background: #ffebee;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }
        .success {
            margin-top: 10px;
            color: #2e7d32;
            background: #e8f5e9;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>User Management</h1>
            <div class="actions">
                <a class="btn btn-muted" href="/">Main App</a>
                <button id="logoutBtn" class="btn btn-muted">Logout</button>
            </div>
        </div>

        <div class="card">
            <h3>Create User</h3>
            <form id="createUserForm">
                <div class="grid">
                    <div class="field">
                        <label for="username">Username</label>
                        <input id="username" type="text" maxlength="64" required>
                    </div>
                    <div class="field">
                        <label for="email">Email</label>
                        <input id="email" type="text" maxlength="255">
                    </div>
                    <div class="field">
                        <label for="password">Password</label>
                        <input id="password" type="password" required>
                    </div>
                    <div class="field">
                        <label for="isAdmin">Admin</label>
                        <select id="isAdmin">
                            <option value="false">No</option>
                            <option value="true">Yes</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="isActive">Active</label>
                        <select id="isActive">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 12px;">
                    <button class="btn btn-primary" type="submit">Create</button>
                </div>
            </form>
            <div id="messageError" class="error"></div>
            <div id="messageSuccess" class="success"></div>
        </div>

        <div class="card">
            <h3>Users</h3>
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Admin</th>
                        <th>Active</th>
                        <th>Failed Logins</th>
                        <th>Locked</th>
                        <th>Last Login (UTC)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // XSS Protection: Escape HTML special characters
        function escapeHTML(str) {
            if (str == null) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        const usersBody = document.getElementById('usersBody');
        const createUserForm = document.getElementById('createUserForm');
        const msgErr = document.getElementById('messageError');
        const msgOk = document.getElementById('messageSuccess');

        function showError(message) {
            msgOk.style.display = 'none';
            msgErr.textContent = message;
            msgErr.style.display = 'block';
        }

        function showSuccess(message) {
            msgErr.style.display = 'none';
            msgOk.textContent = message;
            msgOk.style.display = 'block';
        }

        async function loadUsers() {
            const response = await fetch('/web/users/list');
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.error || 'Failed to load users');
            }

            usersBody.innerHTML = '';
            for (const user of result.users) {
                const isLocked = user.failed_login_counter >= 5;
                const failedClass = isLocked ? 'locked' : (user.failed_login_counter >= 3 ? 'warning' : '');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHTML(user.username)}</td>
                    <td>${escapeHTML(user.email || '')}</td>
                    <td class="status ${user.admin_flag ? 'ok' : 'bad'}">${user.admin_flag ? 'Yes' : 'No'}</td>
                    <td class="status ${user.active_flag ? 'ok' : 'bad'}">${user.active_flag ? 'Yes' : 'No'}</td>
                    <td class="status ${failedClass}">${user.failed_login_counter}/5</td>
                    <td class="status ${isLocked ? 'locked' : 'ok'}">${isLocked ? 'LOCKED' : 'No'}</td>
                    <td>${escapeHTML(user.last_login_datetime || '')}</td>
                    <td>
                        <button class="btn btn-muted" data-username="${escapeHTML(user.username)}" data-field="admin_flag" data-value="${user.admin_flag ? '0' : '1'}">
                            Toggle Admin
                        </button>
                        <button class="btn btn-muted" data-username="${escapeHTML(user.username)}" data-field="active_flag" data-value="${user.active_flag ? '0' : '1'}">
                            Toggle Active
                        </button>
                        <button class="btn ${isLocked ? 'btn-primary' : 'btn-muted'}" data-username="${escapeHTML(user.username)}" data-action="reset-password">
                            Reset Password
                        </button>
                    </td>
                `;
                usersBody.appendChild(tr);
            }

            usersBody.querySelectorAll('button[data-username]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    try {
                        const username = btn.getAttribute('data-username');
                        const action = btn.getAttribute('data-action');

                        // Handle password reset
                        if (action === 'reset-password') {
                            const newPassword = prompt(`Enter new password for user "${username}":\n\nPassword requirements:\n- At least 8 characters\n- 3 of 4: lowercase, uppercase, digits, special chars`);
                            if (!newPassword) return; // User cancelled

                            const response = await fetch('/web/users/reset-password', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ username, password: newPassword })
                            });
                            const result = await response.json();
                            if (!response.ok || !result.success) {
                                throw new Error(result.error || 'Password reset failed');
                            }

                            showSuccess(result.message || 'Password reset successfully');
                            await loadUsers();
                            return;
                        }

                        // Handle toggle actions
                        const field = btn.getAttribute('data-field');
                        const value = btn.getAttribute('data-value') === '1';

                        const payload = { username };
                        payload[field] = value;

                        const response = await fetch('/web/users/update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const result = await response.json();
                        if (!response.ok || !result.success) {
                            throw new Error(result.error || 'Update failed');
                        }

                        showSuccess('User updated');
                        await loadUsers();
                    } catch (error) {
                        showError(error.message);
                    }
                });
            });
        }

        createUserForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            try {
                const payload = {
                    username: document.getElementById('username').value,
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value,
                    admin_flag: document.getElementById('isAdmin').value === 'true',
                    active_flag: document.getElementById('isActive').value === 'true',
                };

                const response = await fetch('/web/users/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Create failed');
                }

                showSuccess('User created');
                createUserForm.reset();
                await loadUsers();
            } catch (error) {
                showError(error.message);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await fetch('/web/logout', { method: 'POST' });
            window.location.href = '/web/login';
        });

        loadUsers().catch(error => showError(error.message));
    </script>
</body>
</html>
